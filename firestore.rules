
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is an admin.
    // IMPORTANT: You must replace the placeholder UIDs below with the
    // actual Firebase User IDs (UIDs) of your admin accounts from the console.
    function isAdmin() {
      // List of admin User IDs (UIDs)
      let admin_uids = [
        'REPLACE_WITH_YOUR_ADMIN_UID_1',
        'llanes.joseph.m@gmail.com', // Example, replace with a real UID
        'super@user.com' // Example, replace with a real UID
      ];
      return request.auth != null && request.auth.uid in admin_uids;
    }

    // Helper function to check if a user is logged in.
    function isAuthenticated() {
      return request.auth != null;
    }

    // Rules for the 'events' collection and its subcollections
    match /events/{eventId}/{document=**} {
      // Admins have full read and write access to all event data and subcollections.
      allow read, write: if isAdmin();
      
      // Any authenticated user can read documents in the 'events' collection itself,
      // and from the 'arenas', 'schedule', and 'rubrics' subcollections.
      // This allows non-admins to view schedules and leaderboards.
      // The path capture {document} with `get` ensures this rule applies correctly.
      allow get: if isAuthenticated() && (
        !exists(/databases/$(database)/documents/events/$(eventId)/competitors/$(request.resource.id))
      );
      
       // Authenticated users can list documents in specific subcollections
      allow list: if isAuthenticated() && (
          // Allow listing events collection itself
          (resource.id == eventId) || 
          // Allow listing these specific subcollections
          (request.path[4] in ['arenas', 'schedule', 'rubrics', 'competitors'])
      );
    }
  }
}
